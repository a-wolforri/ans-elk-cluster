global
    maxconn {{ haproxy_maxconn.global }}
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    mode               tcp
    log                global
    option             tcplog
{% if haproxy_log_format is defined %}
    log-format         '{{ haproxy_log_format }}'
{% endif %}
    retries            2
    timeout queue      5s
    timeout connect    5s
    timeout client     {{ haproxy_timeout.client }}
    timeout server     {{ haproxy_timeout.server }}
    timeout check      15s

listen stats
    mode http
    bind {{ inventory_hostname }}:{{ haproxy_listen_port.stats }}
    stats enable
    stats uri /stats
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}

frontend elasticsearch_front
    bind {{ inventory_hostname }}:{{ haproxy_listen_port.elastic }}
    mode http
    option httpchk GET /_cluster/health
    default_backend elasticsearch_back

backend elasticsearch_back
mode http
balance {{ haproxy_balance_strategy }}
option httpchk GET /_cluster/health
http-check expect status 200
{% for host in groups['elasticsearch'] %}
    server {{ hostvars[host]['ansible_hostname'] }} {{ hostvars[host]['inventory_hostname']}}:{{ hostvars[host]['elasticsearch_port'] | default(9200) }} check
{% endfor %}